<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOCA AI - ì˜ì–´ë°œì „ì†Œ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', Arial, sans-serif; background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; padding: 30px; background: #FFFFFF; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 3px solid #FF8C00; position: relative; }
        .header h1 { font-size: 2.5rem; color: #FF8C00; margin-bottom: 10px; font-weight: 800; }
        .header p { color: #6B7280; font-size: 1.2rem; }
        .sound-toggle { position: absolute; top: 20px; right: 20px; background: #FF8C00; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 1.5rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .sound-toggle:hover { background: #E6780A; transform: scale(1.1); }
        .sound-toggle.muted { background: #6B7280; }
        .setting-box { background: #FFFFFF; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .setting-section { margin-bottom: 40px; padding-bottom: 30px; border-bottom: 2px solid #F3F4F6; }
        .setting-section:last-child { border-bottom: none; margin-bottom: 0; }
        .setting-section h2 { color: #FF8C00; margin-bottom: 20px; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .favorites-list { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .favorite-item { background: #FFF7ED; border: 2px solid #FF8C00; border-radius: 10px; padding: 8px 12px; cursor: pointer; transition: all 0.3s; font-size: 0.9rem; }
        .favorite-item:hover { background: #FF8C00; color: white; }
        .favorite-remove { margin-left: 8px; color: #6B7280; cursor: pointer; }
        .search-input { width: 100%; padding: 15px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem; transition: all 0.3s; margin-bottom: 20px; }
        .search-input:focus { border-color: #FF8C00; outline: none; box-shadow: 0 0 0 3px rgba(255, 140, 0, 0.1); }
        .search-results { background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); max-height: 300px; overflow-y: auto; display: none; margin-top: 10px; }
        .search-result-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #F3F4F6; display: flex; justify-content: space-between; align-items: center; }
        .search-result-item:hover { background: #FFF7ED; }
        .pc-selection { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .category-dropdown { position: relative; }
        .dropdown-button { width: 100%; padding: 15px; background: #F9FAFB; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; }
        .dropdown-button:hover, .dropdown-button.active { background: #FFF7ED; border-color: #FF8C00; }
        .dropdown-menu { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 1000; display: none; max-height: 300px; overflow-y: auto; margin-top: 5px; }
        .dropdown-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #F3F4F6; display: flex; justify-content: space-between; align-items: center; }
        .dropdown-item:hover { background: #FFF7ED; }
        .range-selection { display: flex; gap: 30px; align-items: flex-start; }
        .range-inputs { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; }
        .range-inputs input { padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem; width: 80px; text-align: center; }
        .range-inputs button { padding: 10px 20px; background: #FF8C00; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; padding: 15px; background: #F9FAFB; border-radius: 10px; border: 2px solid #E5E7EB; }
        .day-checkbox { display: flex; align-items: center; padding: 8px; background: white; border-radius: 6px; cursor: pointer; }
        .day-checkbox:hover { background: #FFF7ED; }
        .day-checkbox.checked { background: #FFF7ED; border: 1px solid #FF8C00; }
        .test-type { display: flex; gap: 20px; }
        .test-option { flex: 1; display: flex; align-items: center; padding: 20px; background: #F9FAFB; border-radius: 15px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .test-option:hover, .test-option.selected { background: #FFF7ED; border-color: #FF8C00; }
        .test-option input[type="radio"] { margin-right: 15px; transform: scale(1.3); cursor: pointer; }
        .test-option-content { flex: 1; }
        .test-option-title { font-size: 1.2rem; font-weight: 600; color: #1F2937; margin-bottom: 5px; }
        .test-option-desc { font-size: 0.9rem; color: #6B7280; }
        .start-btn { width: 100%; padding: 25px; background: #FF8C00; color: white; border: none; border-radius: 15px; font-size: 1.4rem; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .start-btn:hover { background: #E6780A; transform: translateY(-2px); box-shadow: 0 10px 20px rgba(255,140,0,0.3); }
        .start-btn:disabled { background: #D1D5DB; cursor: not-allowed; }
        .test-screen { display: none; text-align: center; }
        .test-screen.active { display: block; }
        .word-display { background: #FFFFFF; padding: 80px 40px; border-radius: 25px; margin-bottom: 30px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); border: 4px solid #FF8C00; font-size: 4rem; font-weight: 800; color: #FF8C00; min-height: 250px; display: flex; align-items: center; justify-content: center; position: relative; }
        .black-screen { background: #1F2937; color: #9CA3AF; padding: 80px 40px; border-radius: 25px; margin-bottom: 30px; font-size: 5rem; min-height: 250px; display: none; align-items: center; justify-content: center; }
        .progress { text-align: center; font-size: 1.3rem; font-weight: 600; color: #6B7280; padding: 25px; background: #FFFFFF; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .progress-bar { background: #f0f0f0; height: 12px; border-radius: 6px; margin-top: 15px; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, #FF8C00, #FFA500); height: 100%; border-radius: 6px; width: 0%; transition: width 0.3s; }
        .time-display { position: absolute; top: 20px; right: 20px; background: rgba(255, 140, 0, 0.1); color: #FF8C00; padding: 10px 20px; border-radius: 20px; font-size: 1.2rem; font-weight: 600; }
        .next-btn { background: #10B981; color: white; padding: 15px 30px; border: none; border-radius: 12px; font-size: 1.1rem; cursor: pointer; margin-top: 20px; display: none; }
        .next-btn.show { display: inline-block; }
        .star-btn { background: none; border: none; color: #FFC107; cursor: pointer; font-size: 1.2rem; padding: 0 5px; }
        .loading-message { text-align: center; color: #6B7280; padding: 20px; font-style: italic; }
        .complete-screen { display: none; text-align: center; padding: 40px; }
        .complete-screen.active { display: block; }
        .complete-box { background: #FFFFFF; padding: 50px; border-radius: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); }
        .complete-title { font-size: 3rem; color: #FF8C00; margin-bottom: 30px; }
        .answer-btn { background: #10B981; color: white; padding: 20px 40px; border: none; border-radius: 12px; font-size: 1.2rem; cursor: pointer; margin: 10px; }
        .restart-btn { background: #FF8C00; color: white; padding: 20px 40px; border: none; border-radius: 12px; font-size: 1.2rem; cursor: pointer; margin: 10px; }
        .answer-screen { display: none; padding: 40px; }
        .answer-screen.active { display: block; }
        .answer-table { background: #FFFFFF; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .answer-table table { width: 100%; border-collapse: collapse; }
        .answer-table th { background: #FF8C00; color: white; padding: 20px; text-align: left; }
        .answer-table td { padding: 15px 20px; border-bottom: 1px solid #F3F4F6; }
        .answer-table tr:hover { background: #FFF7ED; }
        .back-btn { background: #6B7280; color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; margin-bottom: 20px; }
        @media (max-width: 768px) { .test-type { flex-direction: column; } .range-selection { flex-direction: column; } }
    </style>
</head>
<body>
<div class="container">
<header class="header">
<button id="soundToggle" class="sound-toggle"><i class="fas fa-volume-up"></i></button>
<h1><i class="fas fa-robot"></i> VOCA AI</h1>
<p>ì˜ì–´ë°œì „ì†Œ ìŠ¤ë§ˆíŠ¸ ë‹¨ì–´ í•™ìŠµ ì‹œìŠ¤í…œ</p>
</header>
<div id="settingScreen" class="setting-box">
<div class="setting-section">
<h2><i class="fas fa-star"></i> ì¦ê²¨ì°¾ê¸°</h2>
<div id="favoritesList" class="favorites-list"></div>
</div>
<div class="setting-section">
<h2><i class="fas fa-book"></i> ë‹¨ì–´ì¥ ì„ íƒ</h2>
<input type="text" id="searchInput" class="search-input" placeholder="ğŸ” ë‹¨ì–´ì¥ ê²€ìƒ‰...">
<div id="searchResults" class="search-results"></div>
<div class="pc-selection">
<div class="category-dropdown">
<button class="dropdown-button" data-category="commercial"><span><i class="fas fa-store"></i> ì‹œì¤‘ë‹¨ì–´ì¥</span><i class="fas fa-chevron-down"></i></button>
<div class="dropdown-menu" id="commercialDropdown"><div class="loading-message">ë¡œë”©ì¤‘...</div></div>
</div>
<div class="category-dropdown">
<button class="dropdown-button" data-category="middle"><span><i class="fas fa-book"></i> ì¤‘ë“±êµê³¼ì„œ</span><i class="fas fa-chevron-down"></i></button>
<div class="dropdown-menu" id="middleDropdown"><div class="loading-message">ë¡œë”©ì¤‘...</div></div>
</div>
<div class="category-dropdown">
<button class="dropdown-button" data-category="high"><span><i class="fas fa-graduation-cap"></i> ê³ ë“±êµê³¼ì„œ</span><i class="fas fa-chevron-down"></i></button>
<div class="dropdown-menu" id="highDropdown"><div class="loading-message">ë¡œë”©ì¤‘...</div></div>
</div>
<div class="category-dropdown">
<button class="dropdown-button" data-category="mock"><span><i class="fas fa-file-alt"></i> ëª¨ì˜ê³ ì‚¬</span><i class="fas fa-chevron-down"></i></button>
<div class="dropdown-menu" id="mockDropdown"><div class="loading-message">ë¡œë”©ì¤‘...</div></div>
</div>
</div>
<div style="margin-top:20px;padding:15px;background:#F0F9FF;border-radius:10px;border-left:4px solid #FF8C00"><strong style="color:#FF8C00">ì„ íƒëœ ë‹¨ì–´ì¥:</strong> <span id="selectedTextbook">ì—†ìŒ</span></div>
</div>
<div class="setting-section">
<h2><i class="fas fa-list-ol"></i> ë²”ìœ„ ì„ íƒ</h2>
<div class="range-selection">
<div style="flex:1">
<h3 style="color:#374151;margin-bottom:15px">ë²”ìœ„ ì§€ì •</h3>
<div class="range-inputs">
<input type="number" id="startRange" min="1" value="1">
<span>~</span>
<input type="number" id="endRange" min="1" value="5">
<button onclick="applyRange()">ì ìš©</button>
</div>
</div>
<div style="flex:1">
<h3 style="color:#374151;margin-bottom:15px">ê°œë³„ ì„ íƒ</h3>
<div class="checkbox-grid" id="dayCheckboxes"></div>
</div>
</div>
<div style="margin-top:20px;padding:15px;background:#F0F9FF;border-radius:10px"><strong style="color:#FF8C00">ì„ íƒ:</strong> <span id="selectedRange">Day 1-5</span></div>
</div>
<div class="setting-section">
<h2><i class="fas fa-layer-group"></i> ë‹¨ì–´ ìœ í˜•</h2>
<div class="test-type">
<label class="test-option"><input type="radio" name="wordType" value="main" checked><div class="test-option-content"><div class="test-option-title"><i class="fas fa-star"></i> ë©”ì¸ë‹¨ì–´ë§Œ</div><div class="test-option-desc">ë©”ì¸ ë‹¨ì–´ë§Œ ì¶œì œ</div></div></label>
<label class="test-option"><input type="radio" name="wordType" value="plus"><div class="test-option-content"><div class="test-option-title"><i class="fas fa-plus-circle"></i> íŒŒìƒì–´(PLUS) í¬í•¨</div><div class="test-option-desc">ë©”ì¸+íŒŒìƒì–´ ëª¨ë‘</div></div></label>
</div>
</div>
<div class="setting-section">
<h2><i class="fas fa-target"></i> í…ŒìŠ¤íŠ¸ ìœ í˜•</h2>
<div class="test-type">
<label class="test-option"><input type="radio" name="testType" value="meaning" checked><div class="test-option-content"><div class="test-option-title"><i class="fas fa-book-open"></i> í•œê¸€ëœ» í…ŒìŠ¤íŠ¸</div><div class="test-option-desc">ì˜ì–´ 3ì´ˆ â†’ í•œê¸€ 4ì´ˆ</div></div></label>
<label class="test-option"><input type="radio" name="testType" value="spelling"><div class="test-option-content"><div class="test-option-title"><i class="fas fa-pencil-alt"></i> ìŠ¤í ë§ í…ŒìŠ¤íŠ¸</div><div class="test-option-desc">í•œê¸€ 3ì´ˆ â†’ ì˜ì–´ 6ì´ˆ</div></div></label>
</div>
</div>
<button id="startTest" class="start-btn" disabled><i class="fas fa-rocket"></i> í…ŒìŠ¤íŠ¸ ì‹œì‘ (ëœë¤ 30ë¬¸ì œ)</button>
</div>
<div id="testScreen" class="test-screen">
<div class="progress">ë¬¸ì œ <span id="currentQuestion">1</span>/30<div class="progress-bar"><div id="progressBar" class="progress-fill"></div></div></div>
<div id="wordDisplay" class="word-display"><div class="time-display" id="timeDisplay">3</div>ì¤€ë¹„ì¤‘...</div>
<div id="blackScreen" class="black-screen"><i class="fas fa-brain"></i></div>
<button id="nextBtn" class="next-btn"><i class="fas fa-arrow-right"></i> ë‹¤ìŒ ë¬¸ì œ</button>
</div>
<div id="completeScreen" class="complete-screen">
<div class="complete-box">
<div class="complete-title"><i class="fas fa-trophy"></i> í…ŒìŠ¤íŠ¸ ì™„ë£Œ!</div>
<div style="font-size:1.5rem;color:#6B7280;margin-bottom:40px">30ë¬¸ì œê°€ ëª¨ë‘ ëë‚¬ìŠµë‹ˆë‹¤!<br>ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!</div>
<button id="showAnswers" class="answer-btn"><i class="fas fa-list"></i> ì •ë‹µ í™•ì¸í•˜ê¸°</button>
<button id="restartTest" class="restart-btn"><i class="fas fa-redo"></i> ë‹¤ì‹œ í…ŒìŠ¤íŠ¸</button>
</div>
</div>
<div id="answerScreen" class="answer-screen">
<button id="backToComplete" class="back-btn"><i class="fas fa-arrow-left"></i> ëŒì•„ê°€ê¸°</button>
<div class="answer-table">
<table>
<thead><tr><th>ë²ˆí˜¸</th><th>ì˜ì–´</th><th>í•œê¸€</th><th>Day</th></tr></thead>
<tbody id="answerTableBody"></tbody>
</table>
</div>
</div>
</div>
<script>
let currentTest = {
    words: [],
    currentIndex: 0,
    testType: 'meaning',
    wordType: 'main',
    selectedDays: [1, 2, 3, 4, 5],
    selectedTextbook: '',
    selectedTextbookId: '',
    soundEnabled: true,
    loadedWords: [],
    minDay: 1,
    maxDay: 50
};
let currentTimer = null;
let favorites = JSON.parse(localStorage.getItem('vocaAIFavorites') || '[]');
let availableTextbooks = [];

const textbookNameMapping = {};

function getCategoryFromFileName(fileName) {
    const fileId = fileName.replace('.csv', '');
    if (fileId.includes('wordmaster') || fileId.includes('voca')) return 'commercial';
    if (fileId.includes('middle') && !fileId.includes('wordmaster')) return 'middle';
    if (fileId.includes('high') && !fileId.includes('mock')) return 'high';
    if (fileId.includes('mock')) return 'mock';
    return 'commercial';
}

function playBeep(freq, dur) {
    if (!currentTest.soundEnabled) return;
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = freq;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + dur / 1000);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + dur / 1000);
    } catch (e) {}
}

async function loadAvailableTextbooks() {
    try {
        const response = await fetch('https://api.github.com/repos/eplant0703/eplant/contents/data');
        if (!response.ok) throw new Error('ì‹¤íŒ¨');
        const files = await response.json();
        availableTextbooks = files.filter(file => file.name.endsWith('.csv')).map(file => {
            const fileId = file.name.replace('.csv', '');
            const koreanName = textbookNameMapping[fileId] || fileId;
            const category = getCategoryFromFileName(file.name);
            return { id: fileId, name: koreanName, fileName: file.name, downloadUrl: file.download_url, category: category };
        });
        console.log('âœ… ë¡œë“œì™„ë£Œ:', availableTextbooks);
        updateAllDropdowns();
    } catch (error) {
        console.error('âŒ ì‹¤íŒ¨:', error);
    }
}

function updateAllDropdowns() {
    ['commercial', 'middle', 'high', 'mock'].forEach(cat => updateDropdownByCategory(cat));
}

function updateDropdownByCategory(category) {
    const dropdown = document.getElementById(category + 'Dropdown');
    const textbooks = availableTextbooks.filter(t => t.category === category);
    if (textbooks.length === 0) {
        dropdown.innerHTML = '<div class="loading-message">ë“±ë¡ëœ ë‹¨ì–´ì¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }
    dropdown.innerHTML = textbooks.map(tb => 
        `<div class="dropdown-item" onclick="selectTextbookById('${tb.id}')">
            <span>${tb.name}</span>
            <button class="star-btn" onclick="event.stopPropagation();addToFavorites('${tb.name}')">â­</button>
         </div>`
    ).join('');
}

async function selectTextbookById(id) {
    const tb = availableTextbooks.find(t => t.id === id);
    if (!tb) { alert('ë‹¨ì–´ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
    currentTest.selectedTextbook = tb.name;
    currentTest.selectedTextbookId = tb.id;
    document.getElementById('selectedTextbook').textContent = tb.name;
    await loadCSVFile(tb.downloadUrl);
    closeAllDropdowns();
}

async function loadCSVFile(url) {
    try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('ì‹¤íŒ¨');
        const csvText = await res.text();
        const words = parseCSV(csvText);
        if (words.length === 0) throw new Error('ë°ì´í„° ì—†ìŒ');
        currentTest.loadedWords = words;
        const days = words.map(w => w.day);
        currentTest.minDay = Math.min(...days);
        currentTest.maxDay = Math.max(...days);
        console.log(`âœ… ${words.length}ê°œ ë¡œë“œ (Day ${currentTest.minDay}~${currentTest.maxDay})`);
        document.getElementById('startRange').min = currentTest.minDay;
        document.getElementById('startRange').max = currentTest.maxDay;
        document.getElementById('endRange').min = currentTest.minDay;
        document.getElementById('endRange').max = currentTest.maxDay;
        document.getElementById('startRange').value = currentTest.minDay;
        document.getElementById('endRange').value = Math.min(currentTest.minDay + 4, currentTest.maxDay);
        generateDayCheckboxes();
        applyRange();
        updateStartButton();
    } catch (error) {
        console.error('âŒ ë¡œë“œì‹¤íŒ¨:', error);
        alert('ë‹¨ì–´ì¥ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
}

function parseCSV(csvText) {
    const lines = csvText.trim().split('\n');
    const words = [];
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const parts = line.split(',');
        if (parts.length < 5) continue;
        const textbook = parts[0].trim();
        const day = parseInt(parts[1]);
        const type = parts[2].trim();
        const english = parts[3].trim();
        const korean = parts.slice(4).join(',').trim().replace(/^"|"$/g, '');
        if (!isNaN(day) && english && korean && type) {
            words.push({ textbook, day, type, english, korean });
        }
    }
    return words;
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ¤– VOCA AI ì‹œì‘!');
    loadAvailableTextbooks();
    document.getElementById('startTest').addEventListener('click', startTest);
    document.getElementById('showAnswers').addEventListener('click', showAnswerScreen);
    document.getElementById('restartTest').addEventListener('click', () => location.reload());
    document.getElementById('backToComplete').addEventListener('click', () => showScreen('completeScreen'));
    document.getElementById('nextBtn').addEventListener('click', goToNextQuestion);
    document.getElementById('soundToggle').addEventListener('click', toggleSound);
    document.querySelectorAll('input[name="testType"]').forEach(r => {
        r.addEventListener('change', function() { currentTest.testType = this.value; });
    });
    document.querySelectorAll('input[name="wordType"]').forEach(r => {
        r.addEventListener('change', function() { currentTest.wordType = this.value; updateStartButton(); });
    });
    document.querySelectorAll('.dropdown-button').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDropdown(btn.dataset.category);
        });
    });
    document.addEventListener('click', closeAllDropdowns);
});

function toggleSound() {
    currentTest.soundEnabled = !currentTest.soundEnabled;
    const btn = document.getElementById('soundToggle');
    if (currentTest.soundEnabled) {
        btn.innerHTML = '<i class="fas fa-volume-up"></i>';
        btn.classList.remove('muted');
        playBeep(800, 150);
    } else {
        btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
        btn.classList.add('muted');
    }
}

function addToFavorites(textbook) {
    if (!favorites.includes(textbook) && favorites.length < 7) {
        favorites.push(textbook);
        localStorage.setItem('vocaAIFavorites', JSON.stringify(favorites));
    }
}

function toggleDropdown(category) {
    const dropdown = document.getElementById(category + 'Dropdown');
    const button = document.querySelector(`[data-category="${category}"]`);
    const isOpen = dropdown.style.display === 'block';
    closeAllDropdowns();
    if (!isOpen) {
        dropdown.style.display = 'block';
        button.classList.add('active');
    }
}

function closeAllDropdowns() {
    document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
    document.querySelectorAll('.dropdown-button').forEach(b => b.classList.remove('active'));
}

function generateDayCheckboxes() {
    const container = document.getElementById('dayCheckboxes');
    container.innerHTML = '';
    for (let i = currentTest.minDay; i <= currentTest.maxDay; i++) {
        const label = document.createElement('label');
        label.className = 'day-checkbox';
        label.innerHTML = `<input type="checkbox" value="${i}" ${currentTest.selectedDays.includes(i) ? 'checked' : ''}>Day ${i}`;
        label.querySelector('input').addEventListener('change', function() {
            if (this.checked) {
                if (!currentTest.selectedDays.includes(i)) currentTest.selectedDays.push(i);
                label.classList.add('checked');
            } else {
                currentTest.selectedDays = currentTest.selectedDays.filter(d => d !== i);
                label.classList.remove('checked');
            }
            currentTest.selectedDays.sort((a, b) => a - b);
            updateSelectedRange();
            updateStartButton();
        });
        if (currentTest.selectedDays.includes(i)) label.classList.add('checked');
        container.appendChild(label);
    }
}

function applyRange() {
    const start = parseInt(document.getElementById('startRange').value);
    const end = parseInt(document.getElementById('endRange').value);
    if (start > end) { alert('ì‹œì‘ì´ ëë³´ë‹¤ í´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
    currentTest.selectedDays = [];
    for (let i = start; i <= end; i++) currentTest.selectedDays.push(i);
    document.querySelectorAll('.day-checkbox input').forEach(cb => {
        const day = parseInt(cb.value);
        cb.checked = currentTest.selectedDays.includes(day);
        if (cb.checked) cb.parentElement.classList.add('checked');
        else cb.parentElement.classList.remove('checked');
    });
    updateSelectedRange();
    updateStartButton();
}

function updateSelectedRange() {
    const display = document.getElementById('selectedRange');
    if (currentTest.selectedDays.length === 0) {
        display.textContent = 'ì—†ìŒ';
        return;
    }
    const sorted = [...currentTest.selectedDays].sort((a, b) => a - b);
    if (sorted.length <= 5) display.textContent = sorted.map(d => `Day ${d}`).join(', ');
    else display.textContent = `Day ${sorted[0]}~${sorted[sorted.length - 1]} (${sorted.length}ê°œ)`;
}

function updateStartButton() {
    const btn = document.getElementById('startTest');
    const hasTextbook = currentTest.loadedWords.length > 0;
    const hasDays = currentTest.selectedDays.length > 0;
    if (hasTextbook && hasDays) {
        let filtered = currentTest.loadedWords.filter(w => currentTest.selectedDays.includes(w.day));
        if (currentTest.wordType === 'main') filtered = filtered.filter(w => w.type === 'ë©”ì¸');
        if (filtered.length >= 30) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-rocket"></i> í…ŒìŠ¤íŠ¸ ì‹œì‘ (ëœë¤ 30ë¬¸ì œ)';
        } else {
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ìµœì†Œ 30ê°œ í•„ìš” (í˜„ì¬ ${filtered.length}ê°œ)`;
        }
    } else {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-rocket"></i> í…ŒìŠ¤íŠ¸ ì‹œì‘ (ëœë¤ 30ë¬¸ì œ)';
    }
}

function startTest() {
    let filtered = currentTest.loadedWords.filter(w => currentTest.selectedDays.includes(w.day));
    if (currentTest.wordType === 'main') filtered = filtered.filter(w => w.type === 'ë©”ì¸');
    if (filtered.length < 30) { alert('ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤'); return; }
    currentTest.words = shuffleArray(filtered).slice(0, 30);
    currentTest.currentIndex = 0;
    showScreen('testScreen');
    showNextWord();
}

function shuffleArray(arr) {
    const shuffled = [...arr];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

function showNextWord() {
    if (currentTest.currentIndex >= 30) {
        showScreen('completeScreen');
        playBeep(1000, 500);
        return;
    }
    const word = currentTest.words[currentTest.currentIndex];
    const wordDisplay = document.getElementById('wordDisplay');
    const blackScreen = document.getElementById('blackScreen');
    const nextBtn = document.getElementById('nextBtn');
    document.getElementById('currentQuestion').textContent = currentTest.currentIndex + 1;
    document.getElementById('progressBar').style.width = ((currentTest.currentIndex + 1) / 30 * 100) + '%';
    nextBtn.classList.remove('show');
    if (currentTest.testType === 'meaning') {
        wordDisplay.style.display = 'flex';
        wordDisplay.textContent = word.english;
        blackScreen.style.display = 'none';
        playBeep(800, 150);
        startTimer(3, () => {
            wordDisplay.style.display = 'none';
            blackScreen.style.display = 'flex';
            playBeep(400, 150);
            startTimer(4, () => {
                nextBtn.classList.add('show');
                playBeep(600, 300);
            });
        });
    } else {
        wordDisplay.style.display = 'flex';
        wordDisplay.textContent = word.korean;
        blackScreen.style.display = 'none';
        playBeep(800, 150);
        startTimer(3, () => {
            wordDisplay.style.display = 'none';
            blackScreen.style.display = 'flex';
            playBeep(400, 150);
            startTimer(6, () => {
                nextBtn.classList.add('show');
                playBeep(600, 300);
            });
        });
    }
}

function startTimer(sec, callback) {
    if (currentTimer) clearInterval(currentTimer);
    let timeLeft = sec;
    document.getElementById('timeDisplay').textContent = sec;
    currentTimer = setInterval(() => {
        timeLeft--;
        document.getElementById('timeDisplay').textContent = timeLeft;
        if (timeLeft <= 0) {
            clearInterval(currentTimer);
            callback();
        }
    }, 1000);
}

function goToNextQuestion() {
    currentTest.currentIndex++;
    showNextWord();
}

function showScreen(screenId) {
    document.getElementById('settingScreen').style.display = 'none';
    document.getElementById('testScreen').classList.remove('active');
    document.getElementById('completeScreen').classList.remove('active');
    document.getElementById('answerScreen').classList.remove('active');
    if (screenId === 'testScreen') document.getElementById('testScreen').classList.add('active');
    else if (screenId === 'completeScreen') document.getElementById('completeScreen').classList.add('active');
    else if (screenId === 'answerScreen') document.getElementById('answerScreen').classList.add('active');
    else document.getElementById('settingScreen').style.display = 'block';
}

function showAnswerScreen() {
    showScreen('answerScreen');
    const tbody = document.getElementById('answerTableBody');
    tbody.innerHTML = currentTest.words.map((w, i) => 
        `<tr><td>${i + 1}</td><td><strong>${w.english}</strong></td><td>${w.korean}</td><td>Day ${w.day}</td></tr>`
    ).join('');
}
</script>
</body>
</html>
